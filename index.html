<!DOCTYPE html>
<html>
<head>
    <title>Südtirol Wikidata Status</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info-box {
            position: absolute; bottom: 20px; left: 20px; z-index: 1000;
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .legend-item { margin: 5px 0; }
        .dot { height: 10px; width: 10px; display: inline-block; border-radius: 50%; margin-right: 5px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="info-box">
    <div class="legend-item"><span class="dot" style="background: #ff4444;"></span>Fehlend: <b id="count-missing">--</b></div>
    <div class="legend-item"><span class="dot" style="background: #44cc44;"></span>Erledigt: <b id="count-done">--</b></div>
    <div style="font-size:0.8em; color:#888; margin-top:5px;" id="date"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
    var map = L.map('map').setView([46.6, 11.4], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);

    // Layer Gruppen
    var missingGroup = L.markerClusterGroup({disableClusteringAtZoom: 14});
    var doneGroup = L.markerClusterGroup({disableClusteringAtZoom: 14});

    fetch('data.geojson', {cache: "no-store"})
        .then(r => {
            const d = r.headers.get('Last-Modified');
            if(d) document.getElementById('date').innerText = new Date(d).toLocaleString();
            return r.json();
        })
        .then(data => {
            let missingCount = 0;
            let doneCount = 0;

            L.geoJSON(data, {
                pointToLayer: function (feature, latlng) {
                    // Stil basierend auf Status
                    var isMissing = feature.properties.status === "missing";
                    var color = isMissing ? "#ff4444" : "#44cc44";
                    
                    return L.circleMarker(latlng, {
                        radius: 8,
                        fillColor: color,
                        color: "#fff",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: function (feature, layer) {
                    var p = feature.properties;
                    var isMissing = p.status === "missing";
                    
                    if (isMissing) missingCount++; else doneCount++;

                    // JOSM Link nur bei fehlenden sinnvoll, aber überall möglich
                    var dist = 0.0005;
                    var lat = feature.geometry.coordinates[1];
                    var lon = feature.geometry.coordinates[0];
                    var josm = `http://127.0.0.1:8111/load_and_zoom?left=${lon-dist}&right=${lon+dist}&top=${lat+dist}&bottom=${lat-dist}&select=node`;
                    
                    var popup = `<b>${p.name}</b><br>${p.wikidata}<br>`;
                    if(isMissing) {
                        popup += `<br><a href="${josm}" target="hiddenIframe" style="background:#0078A8;color:white;padding:5px;display:block;text-align:center;text-decoration:none;border-radius:4px;">In JOSM öffnen</a>`;
                    } else {
                        popup += `<br><i style="color:green">Bereits in OSM</i>`;
                    }
                    layer.bindPopup(popup);

                    // Zu richtiger Gruppe hinzufügen
                    if (isMissing) missingGroup.addLayer(layer);
                    else doneGroup.addLayer(layer);
                }
            });

            // Layer Control hinzufügen
            var overlays = {
                "<span style='color:#ff4444'>Fehlend / To-Do</span>": missingGroup,
                "<span style='color:#44cc44'>Bereits in OSM</span>": doneGroup
            };
            L.control.layers(null, overlays, {collapsed: false}).addTo(map);

            // Standardmäßig NUR fehlende anzeigen
            map.addLayer(missingGroup);
            
            // Stats update
            document.getElementById('count-missing').innerText = missingCount;
            document.getElementById('count-done').innerText = doneCount;
        });
</script>
<iframe name="hiddenIframe" style="display:none;"></iframe>
</body>
</html>
